<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Target Name="BuildResourceWrappers" BeforeTargets="BeforeBuild" Condition="'$(AssemblyName)' == 'Fusion'">
		<PropertyGroup>
			<ResourceWrapperGeneratorCommand>"$(SolutionDir)Tools\ResourceWrapper.Generator.exe" /p "$(ProjectPath)"</ResourceWrapperGeneratorCommand>
			<PseudoBuildDefined>$(DefineConstants.Contains("Pseudo"))</PseudoBuildDefined>
			<ResourceWrapperGeneratorCommand Condition="$(PseudoBuildDefined)">$(ResourceWrapperGeneratorCommand) Pseudo=$(RootNamespace).Properties.Resources</ResourceWrapperGeneratorCommand>

			<TempFile>$(MSBuildProjectFullPath).versiontemp</TempFile>
			<VersionInfoFile>$(MSBuildProjectDirectory)\VersionInfo.cs</VersionInfoFile>
			<VersionString>1.$([System.DateTime]::UtcNow.ToString("yy.MM.dd"))</VersionString>
			<VersionInfo>
// Do not change this file manually as it will be regenerated during the next build. To change version edit project file instead.
[assembly: System.Reflection.AssemblyVersion("$(VersionString)")]
[assembly: System.Reflection.AssemblyFileVersion("$(VersionString)")]
			</VersionInfo>

		</PropertyGroup>
		<!--<Message Importance="high" Text=">>> Building Resource Wrappers: $(ResourceWrapperGeneratorCommand)"/>-->
		<Exec Command="$(ResourceWrapperGeneratorCommand)"/>

		<!-- Write to temp file and read back version text to avoid unneeded compilation. -->
		<WriteLinesToFile File="$(TempFile)" Lines="$(VersionInfo)" Overwrite="true" />
		<ReadLinesFromFile File="$(TempFile)">
			<Output TaskParameter="Lines" PropertyName="VersionInfoToBe" />
		</ReadLinesFromFile>
		<Delete Files="$(TempFile)" />
		<ReadLinesFromFile File="$(VersionInfoFile)">
			<Output TaskParameter="Lines" PropertyName="VersionInfoAsIs" />
		</ReadLinesFromFile>
		<WriteLinesToFile File="$(VersionInfoFile)" Lines="$(VersionInfo)" Overwrite="true" Condition=" '$(VersionInfoToBe)' != '$(VersionInfoAsIs)' and '$(Configuration)' == 'Release' "/>
	</Target>
</Project>
